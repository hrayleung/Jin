<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
    color-scheme: light dark;
    --body-font: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
    --code-font: 'SF Mono', Menlo, monospace;
    --body-font-size: 14px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { overflow: hidden; }
body {
    font-family: var(--body-font);
    font-size: var(--body-font-size);
    line-height: 1.6;
    color: light-dark(#1d1d1f, #f5f5f7);
    background: transparent;
    word-wrap: break-word;
    overflow-wrap: break-word;
    -webkit-user-select: text;
    padding: 0;
}
#content {
    display: flow-root;
}
#content > :last-child {
    margin-bottom: 0 !important;
}
h1, h2, h3, h4, h5, h6 { margin-top: 1em; margin-bottom: 0.5em; font-weight: 600; }
h1 { font-size: 1.6em; } h2 { font-size: 1.4em; } h3 { font-size: 1.2em; } h4 { font-size: 1.1em; }
p { margin-bottom: 0.6em; }
p:last-child { margin-bottom: 0; }
a { color: light-dark(#0066cc, #4ca6ff); text-decoration: none; }
a:hover { text-decoration: underline; }
code {
    font-family: var(--code-font);
    font-size: 0.88em;
    background: light-dark(rgba(0,0,0,0.05), rgba(255,255,255,0.08));
    padding: 0.15em 0.4em;
    border-radius: 5px;
    border: 0.5px solid light-dark(rgba(0,0,0,0.08), rgba(255,255,255,0.1));
}
pre {
    margin: 0.6em 0;
    border-radius: 8px;
    overflow-x: auto;
    background: light-dark(#f6f8fa, #161b22) !important;
    position: relative;
    border: 1px solid light-dark(#e1e4e8, #30363d);
}
pre code {
    display: block;
    padding: 0.8em 1em;
    background: none;
    font-size: 0.85em;
    line-height: 1.5;
    white-space: pre;
    overflow-x: auto;
}
.code-block {
    margin: 0.65em 0;
    border: 1px solid light-dark(#d8dee4, #2f3948);
    border-radius: 11px;
    overflow: hidden;
    background: transparent;
    box-shadow: 0 1px 0 light-dark(rgba(15, 23, 42, 0.03), rgba(2, 8, 23, 0.28));
}
.code-block pre {
    margin: 0;
    border: none;
    border-radius: 0;
    background: transparent !important;
}
.code-block pre code {
    padding: 0.9em 1em 1em;
}
.code-block .code-content {
    display: block;
    background: light-dark(#f3f4f6, #2b3038);
}
.code-block .code-content[hidden] {
    display: none !important;
}
.code-block .code-raw[hidden],
.code-block .code-preview[hidden] {
    display: none !important;
}
.code-block .shiki {
    margin: 0 !important;
    border-radius: 0 0 11px 11px !important;
    background: transparent !important;
    color: var(--shiki-light, #1f2937) !important;
}
.code-block .shiki code {
    padding: 0.9em 1em 1em;
    font-size: 0.85em;
    line-height: 1.55;
    white-space: pre;
    overflow-x: auto;
    font-style: normal;
}
.code-block .shiki .line {
    min-height: 1.55em;
}
.code-block .shiki span {
    color: var(--shiki-light, #1f2937);
    font-style: var(--shiki-light-font-style, normal);
    font-weight: var(--shiki-light-font-weight, 400);
    text-decoration: var(--shiki-light-text-decoration, none);
}
.code-block .code-preview {
    padding: 0.95em 1em 1.05em;
    background: light-dark(#f8fafc, #2d323a);
    border-top: 1px solid light-dark(#d8dee6, #3a424c);
}
.code-block .code-preview svg {
    display: block;
    max-width: 100%;
    height: auto;
}
.code-block .code-preview .diagram-preview,
.code-block .code-preview .diagram-preview * {
    font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Noto Sans CJK SC', 'Source Han Sans SC', 'Heiti SC', 'WenQuanYi Micro Hei', sans-serif;
}
.code-block .code-preview .preview-error {
    margin: 0;
    padding: 0.75em 0.9em;
    border-radius: 8px;
    font-size: 0.86em;
    line-height: 1.45;
    white-space: pre-wrap;
    border: 1px solid light-dark(#fecaca, #7f1d1d);
    background: light-dark(#fef2f2, #2a1212);
    color: light-dark(#991b1b, #fca5a5);
}
@media(prefers-color-scheme:dark){
    .code-block .code-content {
        background: #2b3038;
    }
    .code-block .shiki {
        color: var(--shiki-dark, #dbe5f2) !important;
    }
    .code-block .shiki span {
        color: var(--shiki-dark, #dbe5f2);
        font-style: var(--shiki-dark-font-style, normal);
        font-weight: var(--shiki-dark-font-weight, 400);
        text-decoration: var(--shiki-dark-text-decoration, none);
    }
    .code-block .code-preview {
        background: #2d323a;
        border-top: 1px solid #3a424c;
    }
}
.code-block.is-collapsed {
    box-shadow: none;
}
.code-block.is-collapsed .code-header {
    border-bottom-color: transparent;
}
.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    padding: 0.34em 0.68em 0.34em 0.82em;
    background: linear-gradient(180deg, light-dark(#f8fafc, #3b424d), light-dark(#f2f5f8, #343a44));
    border-bottom: 1px solid light-dark(#d8dee4, #4a525f);
    font-size: 0.75em;
    color: light-dark(#4d5b6a, #94a3b8);
    user-select: none;
    -webkit-user-select: none;
}
.code-header .lang-label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    text-transform: lowercase;
    letter-spacing: 0.025em;
}
.code-header .lang-label .lang-logo {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    object-fit: contain;
    flex: 0 0 auto;
}
.code-header .lang-label .lang-logo-fallback {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 14px;
    height: 14px;
    border-radius: 3px;
    font-size: 9px;
    line-height: 1;
    text-transform: uppercase;
    background: light-dark(#e2e8f0, #334155);
    color: light-dark(#334155, #e2e8f0);
}
.code-header .lang-label .lang-text {
    line-height: 1;
}
.code-header .code-actions {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}
.code-header .copy-btn,
.code-header .render-btn,
.code-header .fold-btn {
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    justify-content: center;
    width: 2em;
    height: 2em;
    padding: 0;
    border-radius: 5px;
    border: none;
    background: transparent;
    color: light-dark(#64748b, #9aa8bd);
    font-size: 0.95em;
    line-height: 1;
    opacity: 0.88;
    transition: opacity 0.15s, background 0.15s, color 0.15s;
}
.code-header .copy-btn:hover,
.code-header .render-btn:hover,
.code-header .fold-btn:hover {
    background: light-dark(rgba(15,23,42,0.08), rgba(148,163,184,0.16));
    color: light-dark(#0f172a, #e2e8f0);
}
.code-header .copy-btn.copied {
    opacity: 1;
    color: light-dark(#15803d, #4ade80);
}
.code-header .render-btn.is-active {
    opacity: 1;
    color: light-dark(#0b63f6, #8ab4f8);
    background: light-dark(rgba(11,99,246,0.12), rgba(138,180,248,0.18));
}
.code-header .render-btn.is-loading {
    opacity: 0.55;
    cursor: progress;
}
.code-header .fold-btn.collapsed svg {
    transform: rotate(-90deg);
}
.code-header .copy-btn svg,
.code-header .render-btn svg,
.code-header .fold-btn svg {
    width: 14px;
    height: 14px;
    transition: transform 0.18s ease;
}
blockquote {
    border-left: 3px solid light-dark(#d0d7de, #444c56);
    padding: 0.2em 0 0.2em 1em;
    margin: 0.6em 0;
    color: light-dark(#57606a, #8b949e);
}
ul, ol { padding-left: 1.5em; margin-bottom: 0.6em; }
li { margin-bottom: 0.25em; }
table { border-collapse: collapse; margin: 0.6em 0; width: auto; overflow-x: auto; display: block; }
th, td { border: 1px solid light-dark(#d0d7de, #444c56); padding: 0.4em 0.8em; text-align: left; }
th { background: light-dark(#f6f8fa, #161b22); font-weight: 600; }
hr { border: none; border-top: 1px solid light-dark(#d0d7de, #444c56); margin: 1em 0; }
img { max-width: 100%%; height: auto; border-radius: 6px; }
</style>
</head>
<body>
<div id="content"></div>
<script src="markdown-core-runtime.js"></script>
<script>
var _codeBlockId = 0;
var _codeBlockSrc = {};
var _codeBlockState = {};
var _latestStableBase64 = '';
var _stableRenderTicket = 0;
var _latestStreamBase64 = '';
var _streamRenderTicket = 0;
var _shikiReady = false;
var _shikiRuntimeLoadPromise = null;
var _mathRuntimeLoadPromise = null;
var _mathStyleLoadPromise = null;
var _mathReady = false;
var _mathStyleReady = false;
var _mermaidRuntimeLoadPromise = null;
var _mermaidReadyPromise = null;
var MAX_HIGHLIGHT_CODE_LENGTH = 24000;
var MAX_HIGHLIGHT_CODE_LINES = 700;

function escapeHTML(value) {
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function resolveMermaidFromGlobal() {
    if (!window.mermaid && window.__esbuild_esm_mermaid_nm && window.__esbuild_esm_mermaid_nm.mermaid) {
        window.mermaid = window.__esbuild_esm_mermaid_nm.mermaid;
    }
}

function loadShikiRuntimeScript() {
    if (window.JinShiki && typeof window.JinShiki.prepareHighlighter === 'function') {
        return Promise.resolve(true);
    }
    if (_shikiRuntimeLoadPromise) {
        return _shikiRuntimeLoadPromise;
    }
    _shikiRuntimeLoadPromise = new Promise(function(resolve) {
        var script = document.createElement('script');
        script.src = 'markdown-shiki-runtime.js';
        script.async = true;
        script.onload = function() { resolve(true); };
        script.onerror = function(err) {
            console.warn('[JinShiki] failed to load runtime script', err);
            resolve(false);
        };
        document.head.appendChild(script);
    });
    return _shikiRuntimeLoadPromise;
}

function loadScriptOnce(src, warningLabel) {
    return new Promise(function(resolve) {
        var script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = function() { resolve(true); };
        script.onerror = function(err) {
            console.warn('[' + warningLabel + '] failed to load runtime script', err);
            resolve(false);
        };
        document.head.appendChild(script);
    });
}

function ensureMathStylesheet() {
    if (_mathStyleReady) return Promise.resolve(true);
    if (_mathStyleLoadPromise) return _mathStyleLoadPromise;

    _mathStyleLoadPromise = new Promise(function(resolve) {
        var existing = document.getElementById('jin-katex-style');
        if (existing) {
            _mathStyleReady = true;
            resolve(true);
            return;
        }

        var link = document.createElement('link');
        link.id = 'jin-katex-style';
        link.rel = 'stylesheet';
        link.href = 'markdown-katex-runtime.css';
        link.onload = function() {
            _mathStyleReady = true;
            scheduleHeightReport();
            resolve(true);
        };
        link.onerror = function(err) {
            console.warn('[JinMath] failed to load stylesheet', err);
            resolve(false);
        };
        document.head.appendChild(link);
    });
    return _mathStyleLoadPromise;
}

function loadMathRuntimeScripts() {
    if (window.katex && window.texmath) return Promise.resolve(true);
    return loadScriptOnce('markdown-katex-runtime.js', 'JinMath')
        .then(function(katexLoaded) {
            if (!katexLoaded) return false;
            return loadScriptOnce('markdown-texmath-runtime.js', 'JinMath');
        })
        .then(function(texmathLoaded) {
            return !!(texmathLoaded && window.katex && window.texmath);
        });
}

function ensureMathReady() {
    if (_mathReady && window.katex && window.texmath) {
        return Promise.resolve(true);
    }
    if (_mathRuntimeLoadPromise) {
        return _mathRuntimeLoadPromise;
    }

    _mathRuntimeLoadPromise = Promise.all([
        ensureMathStylesheet(),
        loadMathRuntimeScripts()
    ])
        .then(function(results) {
            var scriptReady = !!results[1];
            _mathReady = scriptReady;
            return scriptReady;
        })
        .catch(function() { return false; });

    return _mathRuntimeLoadPromise;
}

function loadMermaidRuntimeScript() {
    resolveMermaidFromGlobal();
    if (window.mermaid && typeof window.mermaid.render === 'function') {
        return Promise.resolve(true);
    }
    if (_mermaidRuntimeLoadPromise) {
        return _mermaidRuntimeLoadPromise;
    }
    _mermaidRuntimeLoadPromise = new Promise(function(resolve) {
        var script = document.createElement('script');
        script.src = 'markdown-mermaid-runtime.js';
        script.async = true;
        script.onload = function() {
            resolveMermaidFromGlobal();
            resolve(!!(window.mermaid && typeof window.mermaid.render === 'function'));
        };
        script.onerror = function(err) {
            console.warn('[JinMermaid] failed to load runtime script', err);
            resolve(false);
        };
        document.head.appendChild(script);
    });
    return _mermaidRuntimeLoadPromise;
}

function getMermaidRuntime() {
    resolveMermaidFromGlobal();
    if (window.mermaid && typeof window.mermaid.render === 'function') {
        return window.mermaid;
    }
    if (window.__esbuild_esm_mermaid_nm && window.__esbuild_esm_mermaid_nm.mermaid) {
        return window.__esbuild_esm_mermaid_nm.mermaid;
    }
    return null;
}

var copyIcon = '<svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="5.5" y="5.5" width="8" height="8" rx="1.5"/><path d="M3.5 10.5h-1a1 1 0 0 1-1-1v-7a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v1"/></svg>';
var checkIcon = '<svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3.5 8.5 6.5 11.5 12.5 4.5"/></svg>';
var renderIcon = '<svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3.5 12.5 8 5 12.5 5 3.5"/></svg>';
var codeIcon = '<svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 3.5 1.5 8 6 12.5"/><polyline points="10 3.5 14.5 8 10 12.5"/></svg>';
var foldIcon = '<svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><polyline points="3.5 6 8 10 12.5 6"/></svg>';

function escapeHTML(text) {
    return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function escapeAttr(text) {
    return String(text)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

var languageLogoAliases = {
    js: 'javascript',
    jsx: 'javascript',
    mjs: 'javascript',
    cjs: 'javascript',
    ts: 'typescript',
    tsx: 'typescript',
    py: 'python',
    rb: 'ruby',
    sh: 'bash',
    zsh: 'bash',
    shell: 'bash',
    shellscript: 'bash',
    shellsession: 'bash',
    console: 'bash',
    terminal: 'bash',
    fishshell: 'fish',
    nu: 'nushell',
    ps: 'powershell',
    pwsh: 'powershell',
    ps1: 'powershell',
    yml: 'yaml',
    md: 'markdown',
    txt: 'txt',
    plain: 'txt',
    plaintext: 'txt',
    text: 'txt',
    proto: 'protobuf',
    tex: 'latex',
    vuejs: 'vue',
    cplusplus: 'cpp',
    'c++': 'cpp',
    objc: 'c',
    'obj-c': 'c',
    'objective-c': 'c',
    'objective-cpp': 'cpp',
    mmd: 'mermaid',
    mermaid: 'mermaid',
    'mermaid-svg': 'mermaid',
    mermaidsvg: 'mermaid',
    cs: 'csharp',
    'c#': 'csharp',
    golang: 'go',
    gdscript: 'godot',
    dockerfile: 'docker',
    mysql: 'sql',
    postgresql: 'sql',
    sqlite: 'sql',
    pgsql: 'sql'
};

var languageLogoURLs = {
    bash: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/bash/bash-original.svg',
    python: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg',
    javascript: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/javascript/javascript-original.svg',
    typescript: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/typescript/typescript-original.svg',
    swift: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/swift/swift-original.svg',
    go: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/go/go-original.svg',
    rust: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/rust/rust-original.svg',
    zig: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/zig/zig-original.svg',
    nim: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/nim/nim-original.svg',
    ocaml: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/ocaml/ocaml-original.svg',
    haskell: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/haskell/haskell-original.svg',
    elm: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/elm/elm-original.svg',
    clojure: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/clojure/clojure-original.svg',
    lisp: 'https://api.iconify.design/simple-icons/commonlisp.svg?color=%23a38b6d',
    apl: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/apl/apl-original.svg',
    java: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/java/java-original.svg',
    kotlin: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/kotlin/kotlin-original.svg',
    v: 'https://api.iconify.design/simple-icons/v.svg?color=%235f6b77',
    c: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/c/c-original.svg',
    cpp: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/cplusplus/cplusplus-original.svg',
    csharp: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/csharp/csharp-original.svg',
    php: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/php/php-original.svg',
    ruby: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/ruby/ruby-original.svg',
    prolog: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/prolog/prolog-original.svg',
    html: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/html5/html5-original.svg',
    css: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/css3/css3-original.svg',
    svelte: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/svelte/svelte-original.svg',
    vue: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/vuejs/vuejs-original.svg',
    astro: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/astro/astro-original.svg',
    gleam: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/gleam/gleam-original.svg',
    docker: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/docker/docker-original.svg',
    godot: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/godot/godot-original.svg',
    wgsl: 'https://api.iconify.design/simple-icons/webgpu.svg?color=%235184fe',
    solidity: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/solidity/solidity-original.svg',
    latex: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/latex/latex-original.svg',
    protobuf: 'https://api.iconify.design/simple-icons/protocolsdotio.svg?color=%23006A71',
    nushell: 'https://api.iconify.design/simple-icons/nushell.svg?color=%234e9a06',
    fish: 'https://api.iconify.design/simple-icons/fishshell.svg?color=%2334c534',
    powershell: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/powershell/powershell-original.svg',
    sql: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/mysql/mysql-original.svg',
    json: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/javascript/javascript-original.svg',
    yaml: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/yaml/yaml-original.svg',
    txt: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/markdown/markdown-original.svg',
    markdown: 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/markdown/markdown-original.svg',
    mermaid: 'https://api.iconify.design/simple-icons/mermaid.svg?color=%23ff3670'
};

var languageHighlightAliases = {
    nu: 'nushell',
    console: 'shellsession',
    terminal: 'shellsession',
    plain: 'txt',
    plaintext: 'txt',
    text: 'txt'
};

function resolveLanguageLabel(lang) {
    var normalized = '';
    if (window.JinShiki && typeof window.JinShiki.normalizeLanguage === 'function') {
        normalized = window.JinShiki.normalizeLanguage(lang);
    } else {
        normalized = lang ? String(lang).trim().toLowerCase() : '';
    }
    if (!normalized) return 'txt';
    return languageHighlightAliases[normalized] || normalized;
}

function resolveLanguageLogoURL(lang, label) {
    var key = resolveLanguageLabel(lang || label || '');
    key = languageLogoAliases[key] || key;
    return languageLogoURLs[key] || '';
}

function detectRenderableKind(label, code) {
    var lang = String(label || '').trim().toLowerCase();
    if (lang === 'mmd') lang = 'mermaid';
    if (lang === 'mermaid' || lang === 'mermaid-svg' || lang === 'mermaidsvg') return 'mermaid';
    if (lang === 'svg' && isLikelySVGMarkup(code)) return 'svg';
    if ((lang === 'xml' || lang === 'html' || lang === 'txt' || lang === 'plaintext') && isLikelySVGMarkup(code)) {
        return 'svg';
    }
    return '';
}

function isLikelySVGMarkup(code) {
    var text = String(code || '').trim();
    if (!text) return false;
    text = text.replace(/^<\?xml[\s\S]*?\?>\s*/i, '');
    return /^<svg[\s>]/i.test(text);
}

function codeHeaderHTML(id, label, lang, renderKind) {
    var logoURL = resolveLanguageLogoURL(lang, label);
    var fallbackText = String(label || '').slice(0, 2) || 'txt';
    var logo = logoURL
        ? '<img class="lang-logo" src="' + escapeAttr(logoURL) + '" alt="" loading="lazy" referrerpolicy="no-referrer" onerror="this.style.display=&quot;none&quot;" />'
        : '<span class="lang-logo lang-logo-fallback">' + escapeHTML(fallbackText) + '</span>';
    var renderButton = renderKind
        ? '<button type="button" class="render-btn" id="render-' + id + '" title="Render preview" aria-label="Render preview" aria-controls="preview-' + id + '" aria-pressed="false" onclick="toggleCodeRender(' + id + ')">' + renderIcon + '</button>'
        : '';
    return '<div class="code-header"><span class="lang-label">' + logo + '<span class="lang-text">' + escapeHTML(label) + '</span></span><span class="code-actions">' + renderButton + '<button type="button" class="fold-btn" id="fold-' + id + '" title="Collapse code block" aria-label="Collapse code block" aria-controls="content-' + id + '" aria-expanded="true" onclick="toggleCodeFold(' + id + ')">' + foldIcon + '</button><button type="button" class="copy-btn" id="copy-' + id + '" title="Copy code" aria-label="Copy code" onclick="copyCode(' + id + ')">' + copyIcon + '</button></span></div>';
}

function wrapShikiCodeBlock(id, label, shikiHTML, lang, renderKind) {
    var preview = renderKind ? '<div class="code-preview" id="preview-' + id + '" hidden></div>' : '';
    return '<div class="code-block shiki-block" id="code-block-' + id + '">' + codeHeaderHTML(id, label, lang, renderKind) + '<div class="code-content" id="content-' + id + '"><div class="code-raw" id="raw-' + id + '">' + shikiHTML + '</div>' + preview + '</div></div>';
}

function decodeBase64UTF8(base64) {
    var bytes = Uint8Array.from(atob(base64), function(c) { return c.charCodeAt(0); });
    return new TextDecoder('utf-8').decode(bytes);
}

function copyCode(id) {
    var text = _codeBlockSrc[id] || '';
    var btn = document.getElementById('copy-' + id);
    function onSuccess() {
        if (btn) { btn.innerHTML = checkIcon; btn.classList.add('copied'); setTimeout(function(){ btn.innerHTML = copyIcon; btn.classList.remove('copied'); }, 1500); }
    }
    if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.copyText) {
        window.webkit.messageHandlers.copyText.postMessage(text);
        onSuccess();
    } else if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(onSuccess);
    }
}

function abbreviateErrorText(text, maxLength) {
    var value = String(text || '').trim();
    if (!value) return '';
    var limit = typeof maxLength === 'number' && maxLength > 0 ? maxLength : 260;
    return value.length > limit ? value.slice(0, limit) + 'â€¦' : value;
}

function parseSVGRootFromMarkup(svgMarkup) {
    var parser = new DOMParser();
    var xmlDoc = parser.parseFromString(svgMarkup, 'image/svg+xml');
    var xmlError = xmlDoc && xmlDoc.querySelector ? xmlDoc.querySelector('parsererror') : null;

    if (!xmlError) {
        var xmlRoot = xmlDoc ? xmlDoc.documentElement : null;
        if (xmlRoot && String(xmlRoot.nodeName || '').toLowerCase() === 'svg') {
            return { ok: true, root: xmlRoot };
        }
        return { ok: false, error: 'SVG root element is missing or invalid.' };
    }

    var htmlDoc = parser.parseFromString(svgMarkup, 'text/html');
    var htmlRoot = htmlDoc && htmlDoc.querySelector ? htmlDoc.querySelector('svg') : null;
    if (htmlRoot) {
        var serializedHTMLRoot = new XMLSerializer().serializeToString(htmlRoot);
        var reparsedXML = parser.parseFromString(serializedHTMLRoot, 'image/svg+xml');
        var reparsedError = reparsedXML && reparsedXML.querySelector ? reparsedXML.querySelector('parsererror') : null;
        var reparsedRoot = reparsedXML ? reparsedXML.documentElement : null;
        if (!reparsedError && reparsedRoot && String(reparsedRoot.nodeName || '').toLowerCase() === 'svg') {
            return { ok: true, root: reparsedRoot };
        }
    }

    var parseErrorText = String(xmlError.textContent || xmlError.innerText || 'Unknown SVG parse error.');
    return { ok: false, error: 'SVG parse error: ' + abbreviateErrorText(parseErrorText, 320) };
}

function sanitizeSVGMarkupDetailed(svgMarkup, options) {
    var text = String(svgMarkup || '').trim();
    if (!text) return { ok: false, error: 'SVG content is empty.' };
    text = text.replace(/^<\?xml[\s\S]*?\?>\s*/i, '');
    var cjkFontFallback = 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, Source Han Sans SC, Heiti SC, WenQuanYi Micro Hei, sans-serif';
    var allowForeignObject = !!(options && options.allowForeignObject);

    var parsed = parseSVGRootFromMarkup(text);
    if (!parsed.ok || !parsed.root) {
        return { ok: false, error: parsed.error || 'Unable to parse SVG content.' };
    }
    var root = parsed.root;

    var forbiddenTags = allowForeignObject
        ? ['script', 'iframe', 'object', 'embed', 'link', 'meta']
        : ['script', 'foreignObject', 'iframe', 'object', 'embed', 'link', 'meta'];
    forbiddenTags.forEach(function(tagName) {
        var nodes = root.querySelectorAll(tagName);
        nodes.forEach(function(node) { node.remove(); });
    });

    root.querySelectorAll('*').forEach(function(node) {
        Array.from(node.attributes || []).forEach(function(attr) {
            var name = String(attr.name || '').toLowerCase();
            var value = String(attr.value || '').trim();

            if (name.slice(0, 2) === 'on') {
                node.removeAttribute(attr.name);
                return;
            }

            if ((name === 'href' || name === 'xlink:href' || name === 'src' || name === 'data') && !isSafeSVGHref(value)) {
                node.removeAttribute(attr.name);
                return;
            }

            if (name === 'style' && /(?:expression\s*\(|url\s*\(\s*['"]?\s*(?:javascript:|data:text\/html))/i.test(value)) {
                node.removeAttribute(attr.name);
            }
        });
    });

    if (!root.getAttribute('xmlns')) {
        root.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
    }
    if (!root.getAttribute('font-family')) {
        root.setAttribute('font-family', cjkFontFallback);
    }
    root.querySelectorAll('text, tspan').forEach(function(node) {
        if (!node.getAttribute('font-family')) {
            node.setAttribute('font-family', cjkFontFallback);
        }
    });
    if (allowForeignObject) {
        root.querySelectorAll('foreignObject, foreignObject *').forEach(function(node) {
            var styleValue = String(node.getAttribute('style') || '').trim();
            if (!/font-family\s*:/i.test(styleValue)) {
                var mergedStyle = styleValue ? styleValue.replace(/;?\s*$/, '; ') + 'font-family: ' + cjkFontFallback + ';' : 'font-family: ' + cjkFontFallback + ';';
                node.setAttribute('style', mergedStyle);
            }
        });
    }

    var serialized = new XMLSerializer().serializeToString(root);
    if (!serialized || !/^<svg[\s>]/i.test(serialized)) {
        return { ok: false, error: 'Sanitized output is not a valid <svg> element.' };
    }

    return { ok: true, svg: serialized };
}

function sanitizeSVGMarkup(svgMarkup) {
    var result = sanitizeSVGMarkupDetailed(svgMarkup);
    return result.ok ? result.svg : '';
}

function isSafeSVGHref(value) {
    if (!value) return true;
    var normalized = String(value).trim().toLowerCase();
    return normalized.charAt(0) === '#';
}

function renderPreviewErrorHTML(message) {
    return '<pre class="preview-error">' + escapeHTML(message || 'Render failed.') + '</pre>';
}

function ensureMermaidReady() {
    if (!_mermaidReadyPromise) {
        _mermaidReadyPromise = loadMermaidRuntimeScript().then(function(loaded) {
            if (!loaded) return false;
            var mermaidRuntime = getMermaidRuntime();
            if (!mermaidRuntime || typeof mermaidRuntime.render !== 'function') {
                return false;
            }
            if (!window.mermaid) {
                window.mermaid = mermaidRuntime;
            }
            mermaidRuntime.initialize({
                startOnLoad: false,
                securityLevel: 'strict',
                theme: 'base',
                flowchart: {
                    htmlLabels: false
                },
                themeVariables: {
                    fontFamily: 'PingFang SC, Hiragino Sans GB, Microsoft YaHei, Noto Sans CJK SC, Source Han Sans SC, Heiti SC, WenQuanYi Micro Hei, sans-serif'
                },
                deterministicIds: true,
                suppressErrorRendering: true
            });
            return true;
        }).catch(function(err) {
            console.warn('[JinMermaid] initialization failed', err);
            return false;
        });
    }
    return _mermaidReadyPromise;
}

async function renderCodePreview(kind, code, id) {
    if (kind === 'svg') {
        var safeSVGResult = sanitizeSVGMarkupDetailed(code);
        if (!safeSVGResult.ok) {
            return { ok: false, error: safeSVGResult.error || 'Invalid SVG markup.' };
        }
        return { ok: true, html: '<div class="diagram-preview svg-preview">' + safeSVGResult.svg + '</div>' };
    }

    if (kind === 'mermaid') {
        var ready = await ensureMermaidReady();
        if (!ready) return { ok: false, error: 'Mermaid runtime is unavailable.' };
        try {
            var mermaidRuntime = getMermaidRuntime();
            if (!mermaidRuntime || typeof mermaidRuntime.render !== 'function') {
                return { ok: false, error: 'Mermaid runtime is unavailable.' };
            }
            var renderID = 'jin-mermaid-' + id + '-' + Date.now();
            var result = await mermaidRuntime.render(renderID, code);
            var rawResultSVG = result && result.svg ? result.svg : '';
            if (!rawResultSVG) {
                return { ok: false, error: 'Mermaid returned empty SVG output.' };
            }
            var safeResult = sanitizeSVGMarkupDetailed(rawResultSVG, { allowForeignObject: true });
            if (!safeResult.ok) {
                return { ok: false, error: 'Mermaid SVG sanitize failed: ' + safeResult.error };
            }
            return {
                ok: true,
                html: '<div class="diagram-preview mermaid-preview">' + safeResult.svg + '</div>',
                bind: result && typeof result.bindFunctions === 'function' ? result.bindFunctions : null
            };
        } catch (err) {
            var errorMessage = '';
            if (err) {
                if (typeof err === 'string') {
                    errorMessage = err;
                } else if (typeof err.message === 'string' && err.message) {
                    errorMessage = err.message;
                } else if (typeof err.str === 'string' && err.str) {
                    errorMessage = err.str;
                } else {
                    try {
                        errorMessage = JSON.stringify(err);
                    } catch (_) {
                        errorMessage = String(err);
                    }
                }
            }
            return {
                ok: false,
                error: abbreviateErrorText(errorMessage || 'Unknown Mermaid render error.', 320)
            };
        }
    }

    return { ok: false, error: 'Unsupported render type.' };
}

function scheduleHeightReport() {
    setTimeout(reportHeight, 0);
}

function toggleCodeFold(id) {
    var state = _codeBlockState[id];
    if (!state) return;

    var block = document.getElementById('code-block-' + id);
    var content = document.getElementById('content-' + id);
    var foldButton = document.getElementById('fold-' + id);
    if (!content || !foldButton) return;

    state.collapsed = !state.collapsed;
    content.hidden = !!state.collapsed;
    foldButton.setAttribute('aria-expanded', state.collapsed ? 'false' : 'true');
    if (block) {
        block.classList.toggle('is-collapsed', !!state.collapsed);
    }

    if (state.collapsed) {
        foldButton.classList.add('collapsed');
        foldButton.title = 'Expand code block';
        foldButton.setAttribute('aria-label', 'Expand code block');
    } else {
        foldButton.classList.remove('collapsed');
        foldButton.title = 'Collapse code block';
        foldButton.setAttribute('aria-label', 'Collapse code block');
    }
    scheduleHeightReport();
}

async function toggleCodeRender(id) {
    var state = _codeBlockState[id];
    if (!state || !state.renderKind) return;
    if (state.rendering) return;

    if (state.collapsed) {
        toggleCodeFold(id);
    }

    var raw = document.getElementById('raw-' + id);
    var preview = document.getElementById('preview-' + id);
    var renderButton = document.getElementById('render-' + id);
    if (!raw || !preview || !renderButton) return;

    if (state.previewing) {
        state.previewing = false;
        raw.hidden = false;
        preview.hidden = true;
        renderButton.classList.remove('is-active');
        renderButton.innerHTML = renderIcon;
        renderButton.title = 'Render preview';
        renderButton.setAttribute('aria-label', 'Render preview');
        renderButton.setAttribute('aria-pressed', 'false');
        scheduleHeightReport();
        return;
    }

    if (!state.previewRendered) {
        state.rendering = true;
        renderButton.classList.add('is-loading');
        renderButton.disabled = true;

        var rendered = await renderCodePreview(state.renderKind, _codeBlockSrc[id] || '', id);
        preview.innerHTML = rendered.ok ? rendered.html : renderPreviewErrorHTML(rendered.error);
        if (rendered.ok && typeof rendered.bind === 'function') {
            try {
                rendered.bind(preview);
            } catch (bindErr) {
                console.warn('[JinMermaid] bind functions failed', bindErr);
            }
        }
        state.previewRendered = true;

        state.rendering = false;
        renderButton.classList.remove('is-loading');
        renderButton.disabled = false;
    }

    state.previewing = true;
    raw.hidden = true;
    preview.hidden = false;
    renderButton.classList.add('is-active');
    renderButton.innerHTML = codeIcon;
    renderButton.title = 'Show raw code';
    renderButton.setAttribute('aria-label', 'Show raw code');
    renderButton.setAttribute('aria-pressed', 'true');
    scheduleHeightReport();
}

function ensureShikiReady() {
    if (_shikiReady) {
        return Promise.resolve(true);
    }
    return loadShikiRuntimeScript()
        .then(function(loaded) {
            if (!loaded || !window.JinShiki || typeof window.JinShiki.prepareHighlighter !== 'function') {
                return false;
            }
            return window.JinShiki.prepareHighlighter();
        })
        .then(function(ok) {
            _shikiReady = !!ok;
            return _shikiReady;
        })
        .catch(function() { return false; });
}

function addLanguageCandidate(candidates, value) {
    var text = value ? String(value).trim().toLowerCase() : '';
    if (!text) return;
    if (candidates.indexOf(text) === -1) {
        candidates.push(text);
    }
}

function buildHighlightLanguageCandidates(lang, label, renderKind) {
    var candidates = [];
    addLanguageCandidate(candidates, lang);
    addLanguageCandidate(candidates, label);
    addLanguageCandidate(candidates, languageHighlightAliases[String(lang || '').trim().toLowerCase()] || '');
    addLanguageCandidate(candidates, languageHighlightAliases[String(label || '').trim().toLowerCase()] || '');

    if (renderKind === 'svg') {
        addLanguageCandidate(candidates, 'svg');
        addLanguageCandidate(candidates, 'xml');
        addLanguageCandidate(candidates, 'html');
    } else if (renderKind === 'mermaid') {
        addLanguageCandidate(candidates, 'mermaid');
        addLanguageCandidate(candidates, 'markdown');
        addLanguageCandidate(candidates, 'md');
    }

    addLanguageCandidate(candidates, 'txt');
    return candidates;
}

function highlightCodeWithShiki(code, candidates) {
    if (!window.JinShiki || typeof window.JinShiki.highlightCodeToHtmlIfReady !== 'function') {
        return '';
    }
    for (var i = 0; i < candidates.length; i += 1) {
        var html = window.JinShiki.highlightCodeToHtmlIfReady(code, candidates[i]) || '';
        if (html) return html;
    }
    return '';
}

function codeLineCount(text) {
    if (!text) return 0;
    var count = 1;
    for (var i = 0; i < text.length; i += 1) {
        if (text.charCodeAt(i) === 10) count += 1;
    }
    return count;
}

function shouldAttemptCodeHighlight(code) {
    var text = String(code || '');
    if (!text) return true;
    if (text.length > MAX_HIGHLIGHT_CODE_LENGTH) return false;
    return codeLineCount(text) <= MAX_HIGHLIGHT_CODE_LINES;
}

function highlightCodeBlock(str, lang) {
    var id = ++_codeBlockId;
    _codeBlockSrc[id] = str;
    var label = resolveLanguageLabel(lang);
    var renderKind = detectRenderableKind(label, str);
    _codeBlockState[id] = {
        renderKind: renderKind,
        previewRendered: false,
        previewing: false,
        rendering: false,
        collapsed: false
    };

    var candidates = buildHighlightLanguageCandidates(lang, label, renderKind);
    var shikiHTML = '';
    if (shouldAttemptCodeHighlight(str)) {
        shikiHTML = highlightCodeWithShiki(str, candidates);
    }

    if (!shikiHTML) {
        shikiHTML = '<pre class="shiki"><code>' + escapeHTML(str) + '</code></pre>';
    }
    return wrapShikiCodeBlock(id, label, shikiHTML, lang, renderKind);
}

function fenceLanguageFromInfo(info) {
    var text = info ? String(info).trim() : '';
    if (!text) return '';
    return text.split(/\s+/)[0] || '';
}

function installCodeBlockRenderer(instance) {
    instance.renderer.rules.fence = function(tokens, idx) {
        var token = tokens[idx];
        var lang = fenceLanguageFromInfo(token.info);
        return highlightCodeBlock(token.content || '', lang) + '\n';
    };

    instance.renderer.rules.code_block = function(tokens, idx) {
        var token = tokens[idx];
        return highlightCodeBlock(token.content || '', '') + '\n';
    };
}

function createMarkdownParserState() {
    var instance = window.markdownit({
        html: false,
        linkify: true,
        typographer: false
    });
    installCodeBlockRenderer(instance);
    return {
        instance: instance,
        mathInstalled: false
    };
}

function installMathPluginIfPossible(parserState) {
    if (!parserState || parserState.mathInstalled) return parserState && parserState.mathInstalled;
    if (!window.texmath || !window.katex || typeof parserState.instance.use !== 'function') {
        return false;
    }
    parserState.instance.use(window.texmath, {
        engine: window.katex,
        delimiters: ['dollars', 'brackets', 'beg_end'],
        katexOptions: { throwOnError: false, strict: false, trust: true }
    });
    parserState.mathInstalled = true;
    return true;
}

function containsLikelyCodeBlocks(markdownText) {
    var text = String(markdownText || '');
    if (!text) return false;
    if (/(^|\n)(?: {0,3}(?:```|~~~))/.test(text)) return true;
    return /(^|\n)(?: {4}|\t)\S/.test(text);
}

function containsLikelyMath(markdownText) {
    var text = String(markdownText || '');
    if (!text) return false;
    if (text.indexOf('\\') === -1 && text.indexOf('$') === -1) return false;
    if (/\\begin\{[a-zA-Z*]+\}/.test(text)) return true;
    if (/\\\((?:[\s\S]*?)\\\)/.test(text)) return true;
    if (/\\\[(?:[\s\S]*?)\\\]/.test(text)) return true;
    if (/\$\$[\s\S]+?\$\$/.test(text)) return true;
    return /(^|[^\\])\$(?:[^$\n\\]|\\.)+?\$(?!\$)/.test(text);
}

function shouldDeferCodeHighlightUpgrade(options) {
    if (!options || typeof options !== 'object') return false;
    return options.deferCodeHighlightUpgrade === true;
}

function deferredHighlightDelayMs(markdownText) {
    var text = String(markdownText || '');
    if (!text) return 1200;
    var step = Math.max(1, Math.floor(text.length / 64));
    var hash = 0;
    for (var i = 0; i < text.length; i += step) {
        hash = ((hash << 5) - hash + text.charCodeAt(i)) | 0;
    }
    return 1200 + (Math.abs(hash) % 3200);
}

function renderMarkdownContent(parserState, text) {
    _codeBlockId = 0;
    _codeBlockSrc = {};
    _codeBlockState = {};
    document.getElementById('content').innerHTML = parserState.instance.render(text);
    reportHeight();
}

var mdState = createMarkdownParserState();

async function updateContent(base64, options) {
    var ticket = ++_stableRenderTicket;
    _latestStableBase64 = base64;
    var text = decodeBase64UTF8(base64);
    var needsCodeHighlight = containsLikelyCodeBlocks(text);
    var needsMath = containsLikelyMath(text);
    var deferCodeHighlightUpgrade = shouldDeferCodeHighlightUpgrade(options);

    if (needsMath && _mathReady) {
        installMathPluginIfPossible(mdState);
    }

    renderMarkdownContent(mdState, text);

    var rerenderQueued = false;
    function queueRerenderIfCurrent() {
        if (rerenderQueued) return;
        rerenderQueued = true;
        setTimeout(function() {
            rerenderQueued = false;
            if (ticket !== _stableRenderTicket || base64 !== _latestStableBase64) {
                return;
            }
            renderMarkdownContent(mdState, text);
        }, 0);
    }

    if (needsMath && !mdState.mathInstalled) {
        ensureMathReady().then(function(ok) {
            if (!ok) return;
            if (!installMathPluginIfPossible(mdState)) return;
            queueRerenderIfCurrent();
        });
    }

    if (needsCodeHighlight && !_shikiReady) {
        var requestHighlightUpgrade = function() {
            if (ticket !== _stableRenderTicket || base64 !== _latestStableBase64) {
                return;
            }
            ensureShikiReady().then(function(ok) {
                if (!ok) return;
                queueRerenderIfCurrent();
            });
        };

        if (deferCodeHighlightUpgrade) {
            setTimeout(requestHighlightUpgrade, deferredHighlightDelayMs(text));
        } else {
            requestHighlightUpgrade();
        }
    }
}

function measuredHeight() {
    var el = document.getElementById('content');
    if (!el) {
        return Math.max(Math.ceil(document.body ? document.body.scrollHeight : 0), 1);
    }

    var rect = Math.ceil(el.getBoundingClientRect().height || 0);
    var scroll = Math.ceil(el.scrollHeight || 0);
    var offset = Math.ceil(el.offsetHeight || 0);

    return Math.max(rect, scroll, offset, 1) + 2;
}

function reportHeight() {
    var h = measuredHeight();
    _rh = h;
    if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.heightChanged) {
        window.webkit.messageHandlers.heightChanged.postMessage(h);
    }
}

var _rh = 0;
var resizeObserver = new ResizeObserver(function() {
    var h = measuredHeight();
    if (h !== _rh) { reportHeight(); }
});
var contentEl = document.getElementById('content');
if (contentEl) {
    resizeObserver.observe(contentEl);
}
resizeObserver.observe(document.body);

window.updateWithBase64 = updateContent;

// Streaming renderer uses the same Shiki code block rendering as stable mode.
var streamMdState = createMarkdownParserState();

async function updateStreamingContent(base64, options) {
    var ticket = ++_streamRenderTicket;
    _latestStreamBase64 = base64;
    var text = decodeBase64UTF8(base64);
    var needsCodeHighlight = containsLikelyCodeBlocks(text);
    var needsMath = containsLikelyMath(text);
    var deferCodeHighlightUpgrade = shouldDeferCodeHighlightUpgrade(options);

    if (needsMath && _mathReady) {
        installMathPluginIfPossible(streamMdState);
    }

    renderMarkdownContent(streamMdState, text);

    var rerenderQueued = false;
    function queueRerenderIfCurrent() {
        if (rerenderQueued) return;
        rerenderQueued = true;
        setTimeout(function() {
            rerenderQueued = false;
            if (ticket !== _streamRenderTicket || base64 !== _latestStreamBase64) {
                return;
            }
            renderMarkdownContent(streamMdState, text);
        }, 0);
    }

    if (needsMath && !streamMdState.mathInstalled) {
        ensureMathReady().then(function(ok) {
            if (!ok) return;
            if (!installMathPluginIfPossible(streamMdState)) return;
            queueRerenderIfCurrent();
        });
    }

    if (needsCodeHighlight && !_shikiReady) {
        var requestHighlightUpgrade = function() {
            if (ticket !== _streamRenderTicket || base64 !== _latestStreamBase64) {
                return;
            }
            ensureShikiReady().then(function(ok) {
                if (!ok) return;
                queueRerenderIfCurrent();
            });
        };

        if (deferCodeHighlightUpgrade) {
            setTimeout(requestHighlightUpgrade, deferredHighlightDelayMs(text));
        } else {
            requestHighlightUpgrade();
        }
    }
}

window.updateStreamingWithBase64 = updateStreamingContent;
</script>
</body>
</html>
