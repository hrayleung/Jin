name: CI/CD

on:
  pull_request:
    branches:
      - master
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - "LICENSE*"
  push:
    branches:
      - master
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - "LICENSE*"
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      run_package:
        description: "Run full package job (Build app + DMG + artifacts)"
        required: false
        default: false
        type: boolean
      do_release:
        description: "When manually running package, do full release signing/notary/release publish"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test
    runs-on: macos-15
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore SwiftPM cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.2"

      - name: Print Swift version
        run: swift --version

      - name: Run unit tests
        run: swift test

  package:
    name: Build app and DMG
    runs-on: macos-15
    needs: test
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_package == 'true')
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.2"

      - name: Build app bundle
        run: bash Packaging/package.sh

      - name: Validate notarization secrets for release jobs
        if: |
          startsWith(github.ref, 'refs/tags/v') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.do_release == 'true')
        env:
          MACOS_DEVELOPER_ID_APP_CERT_P12_BASE64: ${{ secrets.MACOS_DEVELOPER_ID_APP_CERT_P12_BASE64 }}
          MACOS_DEVELOPER_ID_APP_CERT_PASSWORD: ${{ secrets.MACOS_DEVELOPER_ID_APP_CERT_PASSWORD }}
          MACOS_DEVELOPER_ID_APP_SIGNING_IDENTITY: ${{ secrets.MACOS_DEVELOPER_ID_APP_SIGNING_IDENTITY }}
          APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
          APPLE_NOTARY_ISSUER_ID: ${{ secrets.APPLE_NOTARY_ISSUER_ID }}
          APPLE_NOTARY_KEY_P8_BASE64: ${{ secrets.APPLE_NOTARY_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          missing=0
          for secret_name in \
            MACOS_DEVELOPER_ID_APP_CERT_P12_BASE64 \
            MACOS_DEVELOPER_ID_APP_CERT_PASSWORD \
            MACOS_DEVELOPER_ID_APP_SIGNING_IDENTITY \
            APPLE_NOTARY_KEY_ID \
            APPLE_NOTARY_ISSUER_ID \
            APPLE_NOTARY_KEY_P8_BASE64
          do
            if [[ -z "${!secret_name}" ]]; then
              echo "::error::Missing required secret: ${secret_name}"
              missing=1
            fi
          done

          if [[ "$missing" -ne 0 ]]; then
            exit 1
          fi

      - name: Import Developer ID certificate
        if: |
          startsWith(github.ref, 'refs/tags/v') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.do_release == 'true')
        env:
          MACOS_DEVELOPER_ID_APP_CERT_P12_BASE64: ${{ secrets.MACOS_DEVELOPER_ID_APP_CERT_P12_BASE64 }}
          MACOS_DEVELOPER_ID_APP_CERT_PASSWORD: ${{ secrets.MACOS_DEVELOPER_ID_APP_CERT_PASSWORD }}
        run: |
          set -euo pipefail

          CERT_P12_PATH="$RUNNER_TEMP/developer-id.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/jin-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 24)"

          python3 - <<'PY' "$CERT_P12_PATH"
          import base64
          import os
          import sys

          output_path = sys.argv[1]
          data = base64.b64decode(os.environ["MACOS_DEVELOPER_ID_APP_CERT_P12_BASE64"])
          with open(output_path, "wb") as output_file:
              output_file.write(data)
          PY

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"

          security import "$CERT_P12_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$MACOS_DEVELOPER_ID_APP_CERT_PASSWORD" \
            -A \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

      - name: Sign app bundle
        if: |
          startsWith(github.ref, 'refs/tags/v') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.do_release == 'true')
        env:
          MACOS_DEVELOPER_ID_APP_SIGNING_IDENTITY: ${{ secrets.MACOS_DEVELOPER_ID_APP_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail
          codesign --force --deep --options runtime --timestamp \
            --sign "$MACOS_DEVELOPER_ID_APP_SIGNING_IDENTITY" \
            dist/Jin.app
          codesign --verify --deep --strict --verbose=2 dist/Jin.app

      - name: Create, notarize, and staple DMG
        if: |
          startsWith(github.ref, 'refs/tags/v') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.do_release == 'true')
        env:
          APPLE_NOTARY_KEY_ID: ${{ secrets.APPLE_NOTARY_KEY_ID }}
          APPLE_NOTARY_ISSUER_ID: ${{ secrets.APPLE_NOTARY_ISSUER_ID }}
          APPLE_NOTARY_KEY_P8_BASE64: ${{ secrets.APPLE_NOTARY_KEY_P8_BASE64 }}
          MACOS_DEVELOPER_ID_APP_SIGNING_IDENTITY: ${{ secrets.MACOS_DEVELOPER_ID_APP_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail

          DMG_ROOT="$RUNNER_TEMP/dmg-root"
          APP_NAME="Jin"
          APP_BUNDLE="dist/${APP_NAME}.app"
          DMG_PATH="dist/${APP_NAME}.dmg"
          NOTARY_KEY_PATH="$RUNNER_TEMP/AuthKey_${APPLE_NOTARY_KEY_ID}.p8"

          rm -rf "$DMG_ROOT"
          mkdir -p "$DMG_ROOT"
          cp -R "$APP_BUNDLE" "$DMG_ROOT/${APP_NAME}.app"
          ln -sf /Applications "$DMG_ROOT/Applications"

          rm -f "$DMG_PATH"
          hdiutil create -volname "$APP_NAME" -srcfolder "$DMG_ROOT" -ov -format UDZO "$DMG_PATH"

          codesign --force --timestamp \
            --sign "$MACOS_DEVELOPER_ID_APP_SIGNING_IDENTITY" \
            "$DMG_PATH"

          python3 - <<'PY' "$NOTARY_KEY_PATH"
          import base64
          import os
          import sys

          output_path = sys.argv[1]
          data = base64.b64decode(os.environ["APPLE_NOTARY_KEY_P8_BASE64"])
          with open(output_path, "wb") as output_file:
              output_file.write(data)
          PY

          xcrun notarytool submit "$DMG_PATH" \
            --key "$NOTARY_KEY_PATH" \
            --key-id "$APPLE_NOTARY_KEY_ID" \
            --issuer "$APPLE_NOTARY_ISSUER_ID" \
            --wait

          xcrun stapler staple "$DMG_PATH"
          xcrun stapler validate "$DMG_PATH"

      - name: Create DMG (unsigned)
        if: "!startsWith(github.ref, 'refs/tags/v') && !(github.event_name == 'workflow_dispatch' && github.event.inputs.do_release == 'true')"
        run: |
          set -euo pipefail
          DMG_ROOT="$RUNNER_TEMP/dmg-root"
          APP_NAME="Jin"
          APP_BUNDLE="dist/${APP_NAME}.app"
          DMG_PATH="dist/${APP_NAME}.dmg"

          rm -rf "$DMG_ROOT"
          mkdir -p "$DMG_ROOT"
          cp -R "$APP_BUNDLE" "$DMG_ROOT/${APP_NAME}.app"
          ln -sf /Applications "$DMG_ROOT/Applications"

          rm -f "$DMG_PATH"
          hdiutil create -volname "$APP_NAME" -srcfolder "$DMG_ROOT" -ov -format UDZO "$DMG_PATH"

      - name: Upload app bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: Jin-app-${{ github.run_number }}
          path: dist/Jin.app
          if-no-files-found: error

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: Jin-dmg-${{ github.run_number }}
          path: dist/Jin.dmg
          if-no-files-found: error

      - name: Publish release on version tag
        if: |
          startsWith(github.ref, 'refs/tags/v') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.do_release == 'true')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/Jin.dmg
          generate_release_notes: true
